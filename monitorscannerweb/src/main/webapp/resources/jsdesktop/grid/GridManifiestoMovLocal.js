Ext.define('MyDesktop.grid.GridManifiestoMovLocal', {    extend: 'Ext.grid.Panel',    requires: [        'Ext.grid.column.Action',        'Ext.grid.plugin.CellEditing',        'Ext.form.field.Text',        'Ext.toolbar.TextItem',        'Ext.ux.form.MultiSelect'    ],    stateful: true,    collapsible: false,    multiSelect: true,    stateId: 'stateGridMovLocal',    viewConfig: {        stripeRows: true,        enableTextSelection: true    },	id:undefined,	isConsulta:false,	myScope:undefined,	tipo_translado:'F',	tiporegistro:'',    initComponent: function () {    	    	    	    	var ismenuDesabled=true;		this.myScope = this;		var my_scope = this;		this.store = Ext.create('MyDesktop.store.StoreHistoria',{			//model: 'MyDesktop.models.ModeloDocumento',			proxy: {		        type: 'ajax',		        api: {		            read: '../logproceso/getGuiasTramosViajes?tiporegistro='+my_scope.tiporegistro		        },		        reader: {		                 type: 'json',		                 successProperty: 'success',		                 root : 'proxiArray',		                 messageProperty: 'message',		                 totalProperty : 'totalCount',		        }			}					});		this.selType= 'checkboxmodel';		 this.editing = Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit: 1});		 this.plugins = this.editing;		 		var sm = Ext.create('Ext.selection.CheckboxModel',{mode : 'MULTI'});		this.selModel= sm;		this.loadMask=true;				this.columns = [    	                		                {text     : 'Id Guia Madre',width: 160,sortable : false,dataIndex: 'iddocumentomadre'},    					{text     : 'Id Guia Indiv',width: 160,sortable : false,dataIndex: 'idenvio'},    					{text     : 'Fecha',width: 170,sortable : false,dataIndex: 'fecha'},    					{text     : 'Excepcion',width: 90,sortable : false,dataIndex: 'exclave'},    					{text     : 'Plaza',width: 70,sortable : false,dataIndex: 'plazaorigina'},    					{text     : 'Viaje',width: 120,sortable : false,dataIndex: 'viaje'},    					{text     : 'Ruta',width: 120,sortable : false,dataIndex: 'ruta'},    					{text     : 'Depto Des',width: 120,sortable : false,dataIndex: 'ruta'},    					{text     : 'Cincho',width: 120,sortable : false,dataIndex: 'cincho'},    					{text     : 'Manifiesto',width: 150,sortable : false,dataIndex: 'manifiesto'},    					{text     : 'Cant.Etiq.',width: 85,sortable : true,dataIndex: 'cantidad'}    				];        var hoy = new Date();    	var manana = new Date();    	manana.setDate(manana.getDate() - 1);        this.dockedItems= [{	            dock: 'left',	            xtype: 'toolbar',	            width:257,	            items: [	                    {xtype: 'label', text:'Datos de B�squeda', labelStyle: 'font-weight:bold'},	                    {xtype: 'label', html:'Plaza captura<font color=red>(Filtro por plaza(s))</font>'},	                    {							xtype: 'fieldcontainer',							labelStyle: 'font-weight:bold;padding:0',							layout: 'hbox',							emptyText: 'Corrida',							defaultType: 'textfield',														fieldDefaults: {								  labelWidth: 40,							      labelStyle: 'font-weight:bold'							},							items: [							   							        {xtype: 'myUpperCaseTextField',  flex: 2,name:'plaza',width:200, 							        	margins: '0 0 0 0',enforceMaxLength:true,maxLength:10,allowBlank: false, readOnly:true, id:'id_plaza'+my_scope.id  },							        { xtype:'button', flex: 1,width:30,  margins: '0 0 0 5',  iconCls:'buscar_white',text:'',							        		scope:my_scope,id:'btnPlaza_'+this.id,													handler:this.showPlazas}							]						},		                {xtype: 'tbseparator'},	                    {							xtype: 'fieldcontainer',							labelStyle: 'font-weight:bold;padding:0',							layout: 'hbox',							emptyText: 'Viajes',							defaultType: 'textfield',														fieldDefaults: {								  labelWidth: 40,							      labelStyle: 'font-weight:bold'							},							items: [							   							        {xtype: 'myUpperCaseTextField', labelAlign:'left',  flex: 3,fieldLabel: 'Ruta<font color=red>*</font>',name:'ruta',width:200, 							        	margins: '0 0 0 0',enforceMaxLength:true,maxLength:10,allowBlank: false, readOnly:true, id:'id_viaje'+my_scope.id  },							        { xtype:'button', flex: 1,width:30,  margins: '0 0 0 5',  iconCls:'buscar_white',text:'',							        		scope:my_scope,id:'btnViaje_'+this.id,													handler:this.showViajes}							]						},												{							xtype: 'fieldcontainer',							labelStyle: 'font-weight:bold;padding:0',							layout: 'hbox',							emptyText: 'Tramo',							hidden:true,							defaultType: 'textfield',							fieldDefaults: {								 labelWidth: 40,							      labelStyle: 'font-weight:bold'							},							items: [							   							        {xtype: 'myUpperCaseTextField',  labelAlign:'left', flex: 3,fieldLabel: 'Depto<font color=red>*</font>',name:'deptodes',width:200, 							        	margins: '0 0 0 0',enforceMaxLength:true,maxLength:10,allowBlank: false, readOnly:true,id:'id_tramo'+my_scope.id },							        { xtype:'button', flex: 1,width:30,  margins: '0 0 0 5',  iconCls:'buscar_white',text:'',							        		scope:my_scope,id:'btnTramo_'+this.id,													handler:this.showTramo}							]						},												{xtype: 'tbseparator'},								{xtype: 'label', text:'Muestra registros manifestados'},					            {xtype: 'checkbox',id:'idchkSinManifiestar'+my_scope.id, checked:true},					        	{xtype:'tbspacer'},								{text:'Buscar gu�as',tooltip: "Busca las gu�as posibles a agregar al manifiesto",iconCls:'buscar_blue', 					            	handler:this.consultaRegistros,scope:this  },					            {xtype: 'tbseparator'},					            {xtype: 'label', text:'Manifiesto:'},					            {  xtype: 'textfield',      id:'idmanifiesto'+my_scope.id, maxLength:30, allowBlank:true,width:150},					            {text:'Gu�as Manifiesto',tooltip: "Muestra las gu�as que se agregaron a un manifiesto",iconCls:'buscar_blue', 					            	handler:this.consultaRegistrosManifiesto,scope:this  },					            {text: "Reimprimir Manif.",iconCls:'print_orange', handler:this.generaReimpresionManifiesto,scope:this },					            	  {xtype: 'tbseparator'}, 						            {text: "Limpiar",handler:this.limpiar,scope:this }	            ]	        },	        {	            dock: 'right',	            xtype: 'toolbar',	            items: [	                    {xtype: 'label', text:'Datos para Generar Manifiesto', labelStyle: 'font-weight:bold'},	                    {xtype: 'label', text:'Viaje:'},	                    {xtype: 'myUpperCaseTextField', name:'viaje', id:'id_manifiesto_viaje'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Tramo:'},	                    {xtype: 'myUpperCaseTextField', name:'viaje', id:'id_manifiesto_tramo'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Supervisor:'},	                    {xtype: 'myUpperCaseTextField', name:'supervisor',id:'id_manifiesto_supervisor'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Operador1:'},	                    {xtype: 'myUpperCaseTextField', name:'operador1',id:'id_manifiesto_operador1'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Operador2:'},	                    {xtype: 'myUpperCaseTextField', name:'operador2',id:'id_manifiesto_operador2'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Economico:'},	                    {xtype: 'myUpperCaseTextField', name:'economico',id:'id_manifiesto_economico'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Cincho:'},	                    {xtype: 'myUpperCaseTextField', name:'cincho',id:'id_manifiesto_cincho'+my_scope.id,maxLength:10,allowBlank: true,enforceMaxLength:true},	                    {xtype: 'label', text:'Excluir Gu�as(Separador -ENTER-):'},	                    {	                        xtype     : 'myUpperCaseTextArea',	                        id:'id_excluir_guias'+my_scope.id,maxLength:10,	                        grow      : true,	                        name      : 'guias',	                        anchor    : '100%',	                        height :90	                    }//,	                    //{text: "Genera Manifiesto",iconCls:'print_orange', handler:this.generaManifiesto,scope:this }	            ]	        },	        {	            dock: 'bottom',	            xtype: 'toolbar',	            items: [	                    {xtype: 'tbfill'},	                    {text: "Genera Manifiesto",iconCls:'print_orange', handler:this.generaManifiesto,scope:this }	            ]	        }	        ];                				this.callParent();    },    limpiar:function(){    	var myscope_main =this;    	Ext.getCmp('id_viaje'+myscope_main.id).setValue('');    	Ext.getCmp('id_tramo'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_viaje'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_tramo'+myscope_main.id).setValue();		Ext.getCmp('id_manifiesto_supervisor'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_operador1'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_operador2'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_economico'+myscope_main.id).setValue('');		Ext.getCmp('id_manifiesto_cincho'+myscope_main.id).setValue('');		Ext.getCmp('idmanifiesto'+myscope_main.id).setValue('');		 Ext.getCmp('id_excluir_guias'+myscope_main.id).setValue('');		 myscope_main.getView().getStore().removeAll();    },    showViajes:function(){    	var myscope_main =this;    	var plaza = Ext.getCmp('id_plaza'+myscope_main.id).getValue();    	    	  var grid_frecuencia = new MyDesktop.grid.GridCatalogoTransportista({  			frame:false, border:false,isConsulta:false,tipo:2,  			tiporegistro:myscope_main.tiporegistro, plaza:plaza,  			layout:'fit', tipo_translado:myscope_main.tipo_translado,  			col_name:'Ruta'  		});     	      	  var datos_window = new Ext.Window({  			width    : 350,  			height   : 450,  			title	: 'Ruta',  			closable:true,  			layout:'fit',  			iconCls:'truck_blue',  			resizable:false,  			modal:true,  			items: [grid_frecuencia	],  			headerPosition: 'right',  			buttons:[  			      {text:'Seleccionar', iconCls:'truck_blue', handler:function(){  			    	  var rows = grid_frecuencia.getRowsSelected();  			    	  if (rows.length>0){   	    				   var id_manifiesto_viaje =  Ext.getCmp('id_manifiesto_viaje'+myscope_main.id);   	    				   id_manifiesto_viaje.setValue( rows[0].get("viaje").trim() ); 	    					   	    				   var id_viaje =  Ext.getCmp('id_viaje'+myscope_main.id);   	    				   id_viaje.setValue( rows[0].get("viaje").trim() );    	    				   datos_window.close();	    				  	    			  }  			         }  			      }  			           			]  				  		});   		datos_window.show();    },    showTramo:function(){    	var myscope_main =this;    	var viaje = Ext.getCmp('id_viaje'+myscope_main.id).getValue();    	var plaza = Ext.getCmp('id_plaza'+myscope_main.id).getValue();    	if ((viaje==undefined) || (viaje.trim().length<=0)){    		mensajeAlert("Debe seleccionar un viaje, verifique ...");    	}    	var grid_frecuencia = new MyDesktop.grid.GridCatalogoTransportista({  			frame:false, border:false,isConsulta:false,tipo:3,plaza:plaza,  			layout:'fit',viaje:viaje,tipo_translado:myscope_main.tipo_translado,  			tiporegistro:myscope_main.tiporegistro,  			col_name:'Depto.Destino'  			  		});     	      	  var datos_window = new Ext.Window({  			width    : 350,  			height   : 450,  			title	: 'Tramos',  			closable:true,  			layout:'fit',  			iconCls:'truck_blue',  			resizable:false,  			modal:true,  			items: [grid_frecuencia	],  			headerPosition: 'right',  			buttons:[  			      {text:'Seleccionar', iconCls:'truck_blue', handler:function(){  			    	  var transportista='';  			    	  var rows = grid_frecuencia.getRowsSelected();  			    	  if (rows.length<=0){  	    					//if (!confirm("No se ha seleccionado transportista desea continuar?")){  	    					//	return;  	    					//}  	    			  }else{  	    				Ext.getCmp('id_manifiesto_tramo'+myscope_main.id).setValue( rows[0].get("ruta").trim() ); 	    					Ext.getCmp('id_tramo'+myscope_main.id).setValue( rows[0].get("ruta").trim() ); 	    					datos_window.close();  	    			  }  			    	    			    	  	  			         }  			      }  			           			]  				  		});   		datos_window.show();  		    	    },    consultaRegistrosManifiesto:function(){    	var myscope= this;    			myscope.getView().getStore().reload(				{					params:{						manifiesto:Ext.getCmp('idmanifiesto'+myscope.id).getValue(),						consultaGuiasManifiesto:true						},					callback:function(r,options,success){						 if (r.length<=0){							 mensajeWarning('No existe informaci�n con el criterio de b�squeda selecionados');  													 }else{							 var economico = r[0].data.numeconomico;							 var cincho =r[0].data.cincho;							 							 Ext.getCmp('id_manifiesto_cincho'+myscope.id).setValue(cincho);							 Ext.getCmp('id_manifiesto_economico'+myscope.id).setValue(economico);						 }					 }	  				});				    	    },    consultaRegistros:function(){    	var myscope= this;    	var viaje = Ext.getCmp('id_viaje'+myscope.id).getValue();    	var tramo = Ext.getCmp('id_tramo'+myscope.id).getValue();    	var plaza = Ext.getCmp('id_plaza'+myscope.id).getValue();		   		if (viaje==''){			mensajeAlert("Seleccione Ruta.");			return;		}		/*if (tramo==''){			mensajeAlert("Seleccione Ruta.");			return;		}*/				var sinManifiestar = Ext.getCmp('idchkSinManifiestar'+myscope.id).getValue();				myscope.getView().getStore().reload(				{					params:{						viaje:viaje,						tramo:tramo,						verSoloLasNoManifiestadas:sinManifiestar,						tipotranslado:myscope.tipo_translado,						tiporegistro:myscope.tiporegistro,						 plaza:plaza						},					callback:function(r,options,success){						 if (r.length<=0){							 mensajeWarning('No existe informaci�n con el criterio de b�squeda selecionados');  													 }else{							 var economico = r[0].data.numeconomico;							 var cincho =r[0].data.cincho;							 							 Ext.getCmp('id_manifiesto_cincho'+myscope.id).setValue(cincho);							 Ext.getCmp('id_manifiesto_economico'+myscope.id).setValue(economico);						 }					 }	  				});				    	    },              muestraTransportistas:function(myscope_main){    		    var grid_frecuencia = new MyDesktop.grid.GridCatalogoTransportista({			frame:false, border:false,isConsulta:false,			layout:'fit'		}); 					var datos_window = new Ext.Window({			width    : 350,			height   : 300,			title	: 'Transportista',			closable:true,			layout:'fit',			iconCls:'truck_blue',			resizable:false,			modal:true,			items: [grid_frecuencia	],			headerPosition: 'right',			buttons:[			      {text:'Seleccionar', iconCls:'truck_blue', handler:function(){			    	  var transportista='';			    	  var rows = grid_frecuencia.getRowsSelected();			    	  if (rows.length<=0){	    					//if (!confirm("No se ha seleccionado transportista desea continuar?")){	    					//	return;	    					//}	    			  }else{	    					transportista = rows[0].get("identificador").trim(); 	    			  }			    	  			    	  myscope_main.configuraManifiesto(myscope_main,transportista);				         }			      }			         			]						}); 		datos_window.show();    },       generaManifiesto:function(){    	var myscope_main = this;    	var viaje = Ext.getCmp('id_viaje'+myscope_main.id).getValue();    	var tramo = Ext.getCmp('id_tramo'+myscope_main.id).getValue();    	    	if (viaje==''){			mensajeAlert("Seleccione Ruta.");			return;		}		/*if (tramo==''){			mensajeAlert("Seleccione Tramo.");			return;		}*/		var mensaje = 'Ser�n manifestados todos los registros de la ruta ' +		//viaje+ ' al depto ' + tramo+ ' que no se hayan manifestado y se excluiran ' +		viaje+ ' que no se hayan manifestado y se excluiran ' +		' las gu�as marcadas o capturadas.�Desea continuar?';		//		var mostrartransportistas = Ext.getCmp('mostrartransportistas').getValue();   	 	Ext.MessageBox.confirm('Confirmaci�n',mensaje, function(id, text){      		if ( (id === 'yes')  || (id === 'si') || (id === 'y' ) || (id === 's' ) ){       			      			myscope_main.configuraManifiesto(myscope_main,"");      		}      	 },myscope_main);    },        configuraManifiesto:function(myscope_main,transportista){    	    	var viaje = Ext.getCmp('id_viaje'+myscope_main.id).getValue();    	var tramo = Ext.getCmp('id_tramo'+myscope_main.id).getValue();    	     	var rows =  this.getView().getSelectionModel().getSelection();		var guias_grid_seleccionadas = "";		for(i=0;i<rows.length;i++){												if(rows[i].get("idenvio") ==  "NA"){								if(guias_grid_seleccionadas == ""){										guias_grid_seleccionadas = "'"+rows[i].get("iddocumentomadre")+"'";									}else{															guias_grid_seleccionadas = guias_grid_seleccionadas +","+"'"+rows[i].get("iddocumentomadre")+"'";									}								}else{								if(guias_grid_seleccionadas == ""){										guias_grid_seleccionadas = "'"+rows[i].get("idenvio")+"'";									}else{															guias_grid_seleccionadas = guias_grid_seleccionadas +","+"'"+rows[i].get("idenvio")+"'";									}							}					}		var manifiesto_viaje = Ext.getCmp('id_manifiesto_viaje'+myscope_main.id).getValue();		var manifiesto_tramo = Ext.getCmp('id_manifiesto_tramo'+myscope_main.id).getValue();		var manifiesto_supervisor = Ext.getCmp('id_manifiesto_supervisor'+myscope_main.id).getValue();		var manifiesto_operador1= Ext.getCmp('id_manifiesto_operador1'+myscope_main.id).getValue();		var manifiesto_operador2 = Ext.getCmp('id_manifiesto_operador2'+myscope_main.id).getValue();		var manifiesto_economico = Ext.getCmp('id_manifiesto_economico'+myscope_main.id).getValue();		var manifiesto_cincho = Ext.getCmp('id_manifiesto_cincho'+myscope_main.id).getValue();				var guias_lista = Ext.getCmp('id_excluir_guias'+myscope_main.id).getValue();		if (guias_lista.trim().length>0){			guias_lista = guias_lista.replace(new RegExp('\r?\n','g'), ',');					}		var guias = guias_grid_seleccionadas + guias_lista;		var plazas = Ext.getCmp('id_plaza'+myscope_main.id).getValue();				//Asigna los envios a la ruta de recoleccion		var url='../manifiestomovimientos/generaManifiestoEntradas?manifiesto_viaje=' + manifiesto_viaje +		'&manifiesto_tramo= ' + manifiesto_tramo +'&manifiesto_supervisor='+manifiesto_supervisor+		'&manifiesto_operador1='+manifiesto_operador1+'&manifiesto_operador2='+manifiesto_operador2+		'&manifiesto_cincho='+manifiesto_cincho+'&viaje='+viaje+		'&tramo='+tramo+'&tipotranslado='+myscope_main.tipo_translado+		'&manifiesto_economico='+manifiesto_economico+  "&guias="+guias+		'&tiporegistro=' +myscope_main.tiporegistro + '&plaza='+plazas ;				this.setLoading('Generando manifiestos');		   		var conn = new Ext.data.Connection();   		   		Ext.override(Ext.data.Connection, { timeout: 999999 });   		   		conn.request({   				scope:myscope_main, 				url: url ,				method:'POST',//				defaultHeaders:{'_csrf_header':hv,"_csrf":vt },//				params:{uuid: myscope.uuid, descripcion:text,"_csrf":vt},				success: function(response, opts) {										this.setLoading(false);										var obj = Ext.decode(response.responseText);															var grid_imprimir_manifiestos = Ext.create('MyDesktop.grid.GridImprimeManifiestos',{						datoManif:obj.message,tiporegistro:myscope_main.tiporegistro					}); 										/* Creamos una ventana con las siguientes propiedades					 * y le mandamos el grid para que lo muestre */					var datos_window = new Ext.Window({						width    : 600,						height   : 500,						title	: 'Manifiestos Creados',						closable:true,						layout:'fit',						resizable:false,						modal:true,						items: [grid_imprimir_manifiestos] ,						headerPosition: 'right'						}); 										/* Abrimos la ventana */					datos_window.show();									},				failure: function(response, opts) {	       			if (response.responseText!=undefined){	       				var obj = Ext.decode(response.responseText);	       				if (obj.message!=undefined){	       					mensajeAlert(obj.message);		       			}		       		}       							}   		}); 		//		visorPDF(//				'utils-win-vistaprevia-pdf_file_envio'+ viaje+tramo+myscope_main.id,//				"Visor Manifiesto" ,	url);    },    generaReimpresionManifiesto:function(){    	var myscope_main = this;    	if (!isValidValueCampo('idmanifiesto'+myscope_main.id, 'Indique manifiesto a reimprimir')){			return ;		}    			var url='../manifiestomovimientos/reimprimeManifiesto?manifiesto='+Ext.getCmp('idmanifiesto'+myscope_main.id).getValue()+ 		"&tipomanifiesto=" + myscope_main.tiporegistro;;				visorPDF(				'utils-win-vistapreviareimprime-pdf_file_envio'+ Ext.getCmp('idmanifiesto'+myscope_main.id).getValue(),				"Visor Manifiesto" ,	url);    	    },    showPlazas:function(){    	var myscope_main =this;    	    	var grid_frecuencia = new MyDesktop.grid.GridCatalogoTransportista({  			frame:false, border:false,isConsulta:false,tipo:5,  			tiporegistro:myscope_main.tiporegistro,   			layout:'fit', tipo_translado:myscope_main.tipo_translado  		});     	      	  var datos_window = new Ext.Window({  			width    : 300,  			height   : 450,  			title	: 'Plazas',  			closable:true,  			layout:'fit',  			iconCls:'truck_blue',  			resizable:false,  			modal:true,  			items: [grid_frecuencia	],  			headerPosition: 'right',  			buttons:[  			      {text:'Seleccionar Plaza(s)', iconCls:'truck_blue', handler:function(){  			    	  var rows = grid_frecuencia.getRowsSelected();  			    	  if (rows.length>0){   	    				   var id_obj=  Ext.getCmp('id_plaza'+myscope_main.id);   	    				   var plazas='';   	    				   for (i=0;i<rows.length;i++){   	    					   plazas = plazas+  rows[i].get('viaje')+ ",";   	    				   }   	    				   id_obj.setValue(plazas.trim() );    	    				   	    			  }  			    	 datos_window.close();  			      }  			     }  			           			]  				  		});   		datos_window.show();    },	formatoCeldaDestino : function(value, metaData, record,			rowIndex, colIndex, store) {				return  record.data.destinatario.razonSocial;	},	 formatoCeldaRemitente:function(value, metaData, record, rowIndex, colIndex, store){	    	return  record.data.remitente.razonSocial;	    },		getRowsSelected : function() {		return this.getView().getSelectionModel()				.getSelection();	}	});